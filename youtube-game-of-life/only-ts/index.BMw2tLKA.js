(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();function w(f,t=0){const e={id:0};let s=Date.now();const i=()=>{if(t===0){f(),e.id=requestAnimationFrame(i);return}const o=Date.now(),n=o-s;n>=t&&(f(),s=o-n%t),e.id=requestAnimationFrame(i)};return e.id=requestAnimationFrame(i),e}function C(f,t,e){let s=parseInt(f.value);return isNaN(s)||s<t?s=t:s>e&&(s=e),f.value=s.toString(),s}class y{constructor({injectedNode:t,cellsCountX:e,cellsCountY:s,random:i,speed:o,localStorageUse:n,popupHidden:l}){if(this.cycles=0,this.played=!1,this.interval=500,this.gameTime=0,this.gameStartTime=0,this.gameLastTime=0,this.random=!1,this.speed=0,this.activeCells=0,this.localStorageUse=!1,this.isDragging=!1,this.isRealDragging=!1,this.worker=new Worker(new URL(""+new URL("assets/worker-game-of-life-logic-CDdIy5GX.js",import.meta.url).href,import.meta.url)),this.loading=!1,this.focusedInput=null,this.popupHidden=!1,this.togglePopup=p=>{this.localStorageUse===!0&&this.setLocalStorage("popupHidden",this.popupHidden),this.popupHidden===!0?(this.nodes.popupNode.classList.add("popup_hidden"),this.nodes.popupCloseNode.textContent="Открыть"):(this.nodes.popupNode.classList.remove("popup_hidden"),this.nodes.popupCloseNode.textContent="Скрыть")},this.generateCellByClick=(p,a=!1)=>{if(this.played===!0)return;const d=this.nodes.canvasNode.getBoundingClientRect(),r=p.clientX-d.left,h=p.clientY-d.top,m=Math.floor(r/this.cellSize),u=Math.floor(h/this.cellSize),c=this.getKey(u,m),g=this.field.get(c),v=()=>{this.activeCells--,this.field.set(c,!1),this.sendWorkerDeleteOrCreateCell("delete",c).then()},_=()=>{this.activeCells++,this.field.set(c,!0),this.sendWorkerDeleteOrCreateCell("create",c).then()};g===!1&&a===!0||g===!1&&a===!1?_():g===!0&&a===!1&&v(),this.renderPopulation(),this.drawField()},this.calcSpeedInputChange=()=>{const p=this.played;this.stopGame();const a=this.nodes.popupSpeedRangeNode.valueAsNumber,d=Number(this.nodes.popupSpeedRangeNode.max),r=Number(this.nodes.popupSpeedRangeNode.min),h=d-r,u=(a-r)/h,c=Number((u*9+1).toFixed(1));this.speed=c,this.nodes.popupSpeedInfoNode.textContent=String(this.speed),this.localStorageUse&&this.setLocalStorage("speed",this.speed),p===!0&&this.startGame()},this.clear=()=>{this.loading,this.stopGame(),this.gameTime=0,this.gameLastTime=0,this.gameStartTime=0,this.cycles=0,this.disableInputs(),this.sendWorkerInitFields({random:!1,rows:this.rows,cols:this.cols}).then(p=>{this.drawField(),this.renderTime(),this.renderPopup(),this.enableInputs()})},this.generateNewFields=()=>{this.loading,this.sendWorkerInitFields({random:!0,rows:this.rows,cols:this.cols}).then(p=>{this.cycles=0,this.drawField(),this.renderPopup()})},this.resizeAndDraw=()=>{this.setCanvasSize(),this.drawField()},this.setColorCell=()=>{this.colorCell=getComputedStyle(document.documentElement).getPropertyValue("--color")},this.setColorCellAndDraw=()=>{this.setColorCell(),this.drawField()},this.setCanvasSize=()=>{const p=this.nodes.wrapperCanvasNode.offsetWidth,a=this.nodes.wrapperCanvasNode.offsetHeight,d=this.cols/this.rows,r=Math.min(p,a*d),h=r/d;this.cellSize=r/this.cols;const m=(p-r)/2,u=(a-h)/2;this.nodes.canvasNode.width=r,this.nodes.canvasNode.height=h,this.nodes.wrapperCanvasNode.style.padding=`${u}px ${m}px`},this.stepGame=()=>{if(this.loading!==!0)return this.sendWorkerUpdateField().then(p=>(this.drawField(),this.cycles=this.cycles+1,this.renderPopup(),p))},this.stepAnimationRenderTime=()=>{this.renderTime()},o<1)throw new Error("GameOfLife: speed не может быть меньше 1");if(o>10)throw new Error("GameOfLife: speed не может быть больше 10");this.rows=e,this.cols=s,this.random=i,this.speed=o,this.localStorageUse=n,this.popupHidden=l,this.initNodes(t),this.ctx=this.nodes.canvasNode.getContext("2d"),this.localStorageUse&&this.useLocalStorage(),this.initCalcSpeed(),this.setCanvasSize(),this.setColorCell(),this.initInputNodes(),this.initPopupHidden(),this.sendWorkerInitFields({random:this.random,rows:this.rows,cols:this.cols}).then(({activeCells:p,field:a,buffer:d})=>{this.initEventListeners(),this.drawField(),this.renderPopup()})}initInputNodes(){this.nodes.popupInputRowsNode.value=String(this.rows),this.nodes.popupInputColsNode.value=String(this.cols)}initPopupHidden(){this.togglePopup(this.popupHidden)}disableInputs(){this.nodes.popupInputRowsNode.disabled=!0,this.nodes.popupInputColsNode.disabled=!0}enableInputs(){this.nodes.popupInputRowsNode.disabled=!1,this.nodes.popupInputColsNode.disabled=!1,this.focusedInput!==null&&(this.focusedInput.focus(),this.focusedInput=null)}sendWorkerInitFields({random:t,rows:e,cols:s}){return this.load(),this.disableInputs(),this.worker.postMessage({type:"initFields",payload:{random:t,rows:e,cols:s}}),new Promise((o,n)=>{this.worker.onmessage=l=>{const p=l.data;if(this.loadComplete(),this.enableInputs(),p.type==="result: initFields"){const a=p.data,{activeCells:d,field:r,buffer:h}=a;this.activeCells=d,this.field=r,this.buffer=h,o(a)}n(!1)}})}load(){this.loading=!0,this.nodes.popupLoadNode.classList.add("popup__load_active"),this.nodes.popupNode.classList.add("popup_load")}loadComplete(){this.loading=!1,this.nodes.popupLoadNode.classList.remove("popup__load_active"),this.nodes.popupNode.classList.remove("popup_load")}initEventListeners(){window.addEventListener("resize",this.resizeAndDraw),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",this.setColorCellAndDraw),this.nodes.popupPauseNode.addEventListener("click",()=>{this.played!==!1&&this.stopGame()}),this.nodes.popupPlayNode.addEventListener("click",()=>{this.played!==!0&&this.startGame()}),this.nodes.popupGenerateNode.addEventListener("click",this.generateNewFields),this.nodes.canvasNode.addEventListener("pointerdown",e=>{if(this.loading!==!0){if(e.button===2||e.button===1)return!1;this.isDragging=!0,this.isRealDragging=!1}}),this.nodes.canvasNode.addEventListener("pointermove",e=>{if(e.button===2||e.button===1)return!1;this.isDragging===!0&&this.loading===!1&&(this.isRealDragging=!0,this.generateCellByClick(e,!0))}),document.addEventListener("pointerup",e=>{if(e.button===2||e.button===1)return!1;this.isClickOnElement(e,this.nodes.popupNode)!==!0&&(this.isRealDragging===!1&&this.loading===!1&&this.generateCellByClick(e,!1),this.isDragging=!1,this.isRealDragging=!1)}),this.nodes.popupRandomCheckboxNode.addEventListener("input",()=>{this.random=!this.random,this.localStorageUse&&this.setLocalStorage("random",this.random),this.renderRandom()}),this.nodes.popupSpeedRangeNode.addEventListener("input",this.calcSpeedInputChange),this.nodes.popupClearNode.addEventListener("click",this.clear),this.nodes.popupStepNode.addEventListener("click",()=>{var e;this.disableInputs(),(e=this.stepGame())==null||e.then(s=>{this.enableInputs()})}),this.nodes.popupInputRowsNode.addEventListener("input",()=>{const e=C(this.nodes.popupInputRowsNode,0,2e3);this.localStorageUse&&this.setLocalStorage("rows",e),this.focusedInput=this.nodes.popupInputRowsNode,this.resizeFieldRows(e)}),this.nodes.popupInputColsNode.addEventListener("input",()=>{const e=C(this.nodes.popupInputColsNode,0,2e3);this.localStorageUse&&this.setLocalStorage("cols",e),this.focusedInput=this.nodes.popupInputColsNode,this.resizeFieldCols(e)}),this.nodes.popupCloseNode.addEventListener("click",()=>{this.popupHidden=!this.popupHidden,this.togglePopup(this.popupHidden)})}resizeFieldRows(t){this.loading!==!0&&this.sendWorkerResizeField(t,this.cols,this.random).then(e=>{this.setCanvasSize(),this.drawField(),this.renderTime(),this.renderPopup()})}resizeFieldCols(t){this.loading!==!0&&this.sendWorkerResizeField(this.rows,t,this.random).then(e=>{this.setCanvasSize(),this.drawField(),this.renderTime(),this.renderPopup()})}sendWorkerResizeField(t,e,s){return this.load(),this.disableInputs(),this.worker.postMessage({type:"resizeField",payload:{newRows:t,newCols:e,random:s}}),new Promise((o,n)=>{this.worker.onmessage=l=>{const p=l.data;if(this.loadComplete(),this.enableInputs(),p.type==="result: resizeField"){const a=p.data,{field:d,buffer:r,activeCells:h,rows:m,cols:u}=a;this.field=d,this.buffer=r,this.activeCells=h,this.rows=m,this.cols=u,o(a)}n(!1)}}).catch(()=>{})}isClickOnElement(t,e){let i=t.target;for(;i!=null;){if(i===e)return!0;i=i.parentElement}return!1}sendWorkerDeleteOrCreateCell(t,e){return this.load(),this.worker.postMessage({type:"deleteOrCreateCell",payload:{typeAction:t,key:e}}),new Promise((i,o)=>{this.worker.onmessage=n=>{const l=n.data;if(this.loadComplete(),l.type==="result: deleteOrCreateCell"){const p=l.data;i(p)}o(!1)}})}initCalcSpeed(){const t=Number(this.nodes.popupSpeedRangeNode.max),e=Number(this.nodes.popupSpeedRangeNode.min),s=(this.speed-1)/9,i=e+s*(t-e);this.nodes.popupSpeedRangeNode.value=String(i),this.nodes.popupSpeedInfoNode.textContent=String(this.speed)}useLocalStorage(){const t=this.getLocalStorage();t.random!==void 0&&(this.random=t.random),t.speed!==void 0&&(this.speed=t.speed),t.rows!==void 0&&(this.rows=t.rows),t.cols!==void 0&&(this.cols=t.cols),t.popupHidden!==void 0&&(this.popupHidden=t.popupHidden)}initNodes(t){t.innerHTML=`
			<div class="wrapper">
				<div class="wrapper-canvas">
					<canvas class="canvas"></canvas>
				</div>

				<div class="popup">
					<div class="popup__item popup__play">Play</div>
					<div class="popup__item popup__pause">Пауза</div>
					<div class="popup__item popup__clear">Очистить</div>
					<div class="popup__item popup__step">Шаг</div>
					<div class="popup__item popup__generate">Сгенерировать</div>
					<label class="popup__item popup__random-checkbox-item">
						<input type="checkbox" class="popup__random-checkbox">
						<span>Рандом</span>
					</label>
					<div class="popup__item">
						Время:
						<span class="popup__time">0.0</span>
					</div>
					<div class="popup__item">Поколение: <span class="popup__cycles">0</span></div>
					<div class="popup__item">Население: <span class="popup__population">0</span></div>
					<div class="popup__item">
						<span>Скорость: </span>
						<span class="popup__speed-info">1</span>
					</div>
					<div class="popup__item">
						<input class="popup__speed-range" type="range" min="0" max="100" value="50">
					</div>

					<div class="popup__item popup__item_inputs">
						<input type="number" class="popup__rows popup__inputs" placeholder="rows" min="0" max="2000">
						<input type="number" class="popup__cols popup__inputs" placeholder="cols" min="0" max="2000">
					</div>

					<div class="popup__item popup__close">Скрыть</div>

					<div class="popup__item popup__load">Загрузка</div>

				</div>

			</div>
		`;const e=this._querySelector(t,".popup"),s=this._querySelector(t,".canvas"),i=this._querySelector(t,".wrapper-canvas"),o=this._querySelector(e,".popup__play"),n=this._querySelector(e,".popup__pause"),l=this._querySelector(e,".popup__time"),p=this._querySelector(e,".popup__population"),a=this._querySelector(e,".popup__cycles"),d=this._querySelector(e,".popup__generate"),r=this._querySelector(e,".popup__random-checkbox"),h=this._querySelector(e,".popup__speed-range"),m=this._querySelector(e,".popup__speed-info"),u=this._querySelector(e,".popup__clear"),c=this._querySelector(e,".popup__step"),g=this._querySelector(e,".popup__load"),v=this._querySelector(e,".popup__rows"),_=this._querySelector(e,".popup__cols"),N=this._querySelector(e,".popup__close");this.nodes={canvasNode:s,popupNode:e,popupPlayNode:o,popupPauseNode:n,popupTimeNode:l,popupPopulationNode:p,popupCyclesNode:a,popupGenerateNode:d,wrapperCanvasNode:i,popupRandomCheckboxNode:r,popupSpeedRangeNode:h,popupSpeedInfoNode:m,popupClearNode:u,popupStepNode:c,popupLoadNode:g,popupInputRowsNode:v,popupInputColsNode:_,popupCloseNode:N}}_querySelector(t,e){const s=t.querySelector(e);if(s===null)throw new Error(`GameOfLife: элемент с классом ${e} не найден`);return s}getKey(t,e){return`${t}-${e}`}drawField(){this.load(),this.ctx.clearRect(0,0,this.nodes.canvasNode.width,this.nodes.canvasNode.height);const t=this.cellSize;this.ctx.fillStyle=this.colorCell;for(let e=0;e<this.rows;e++)for(let s=0;s<this.cols;s++){const i=this.getKey(e,s);this.field.get(i)&&this.ctx.fillRect(s*t,e*t,t,t)}this.loadComplete()}sendWorkerUpdateField(){return this.load(),this.worker.postMessage({type:"updateField",payload:{}}),new Promise((e,s)=>{this.worker.onmessage=i=>{const o=i.data;if(this.loadComplete(),o.type==="result: updateField"){const n=o.data,{activeCells:l,field:p,buffer:a}=n;this.activeCells=l,this.field=p,this.buffer=a,e(n)}s(!1)}})}renderPopup(){this.renderPopulation(),this.renderRandom(),this.nodes.popupCyclesNode.textContent=String(this.cycles),this.nodes.popupRandomCheckboxNode.checked=this.random}renderTime(){let t=Date.now()-this.gameStartTime+this.gameLastTime;this.gameStartTime===0&&(t=0),this.gameTime=t,this.nodes.popupTimeNode.textContent=(this.gameTime/1e3).toFixed(1)}renderRandom(){this.random===!0?this.nodes.popupGenerateNode.classList.add("popup__generate_active"):this.nodes.popupGenerateNode.classList.remove("popup__generate_active")}renderPopulation(){this.nodes.popupPopulationNode.textContent=String(this.activeCells)}startGame(){this.disableInputs(),this.played=!0,this.gameStartTime=Date.now(),this.animationObj=w(this.stepGame,this.interval/this.speed**1.5),this.animationTimeId=w(this.stepAnimationRenderTime)}stopGame(){this.played!==!1&&(this.played=!1,this.gameLastTime=this.gameTime,cancelAnimationFrame(this.animationObj.id),cancelAnimationFrame(this.animationTimeId.id),this.enableInputs())}getLocalStorage(){return JSON.parse(localStorage.getItem("life")||"{}")}setLocalStorage(t,e){const s=this.getLocalStorage();s[t]=e,localStorage.setItem("life",JSON.stringify(s))}}const S=document.querySelector(".injected-game-life");if(S===null)throw new Error("injectedNode не найден");new y({cellsCountX:100,cellsCountY:100,random:!1,speed:1,localStorageUse:!0,popupHidden:!1,injectedNode:S});
