var L=Object.defineProperty;var I=(l,t,e)=>t in l?L(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var i=(l,t,e)=>I(l,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const p of o)if(p.type==="childList")for(const n of p.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const p={};return o.integrity&&(p.integrity=o.integrity),o.referrerPolicy&&(p.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?p.credentials="include":o.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function s(o){if(o.ep)return;o.ep=!0;const p=e(o);fetch(o.href,p)}})();function g(l,t=0){const e={id:0};let s=Date.now();const o=()=>{if(t===0){l(),e.id=requestAnimationFrame(o);return}const p=Date.now(),n=p-s;n>=t&&(l(),s=p-n%t),e.id=requestAnimationFrame(o)};return e.id=requestAnimationFrame(o),e}function _(l,t,e){let s=parseInt(l.value);return isNaN(s)||s<t?s=t:s>e&&(s=e),l.value=s.toString(),s}class b{constructor({injectedNode:t,cellsCountX:e,cellsCountY:s,random:o,speed:p,localStorageUse:n,popupHidden:r}){i(this,"ctx");i(this,"rows");i(this,"cols");i(this,"cellSize");i(this,"field");i(this,"buffer");i(this,"colorCell");i(this,"animationObj");i(this,"nodes");i(this,"cycles",0);i(this,"played",!1);i(this,"interval",500);i(this,"gameTime",0);i(this,"gameStartTime",0);i(this,"gameLastTime",0);i(this,"random",!1);i(this,"speed",0);i(this,"activeCells",0);i(this,"localStorageUse",!1);i(this,"isDragging",!1);i(this,"isRealDragging",!1);i(this,"animationTimeId");i(this,"worker",new Worker(new URL("/assets/worker-game-of-life-logic-CDdIy5GX.js",import.meta.url)));i(this,"loading",!1);i(this,"focusedInput",null);i(this,"popupHidden",!1);i(this,"togglePopup",t=>{this.localStorageUse===!0&&this.setLocalStorage("popupHidden",this.popupHidden),this.popupHidden===!0?(this.nodes.popupNode.classList.add("popup_hidden"),this.nodes.popupCloseNode.textContent="Открыть"):(this.nodes.popupNode.classList.remove("popup_hidden"),this.nodes.popupCloseNode.textContent="Скрыть")});i(this,"generateCellByClick",(t,e=!1)=>{if(this.played===!0)return;const s=this.nodes.canvasNode.getBoundingClientRect(),o=t.clientX-s.left,p=t.clientY-s.top,n=Math.floor(o/this.cellSize),r=Math.floor(p/this.cellSize),a=this.getKey(r,n),d=this.field.get(a),u=()=>{this.activeCells--,this.field.set(a,!1),this.sendWorkerDeleteOrCreateCell("delete",a).then()},c=()=>{this.activeCells++,this.field.set(a,!0),this.sendWorkerDeleteOrCreateCell("create",a).then()};d===!1&&e===!0||d===!1&&e===!1?c():d===!0&&e===!1&&u(),this.renderPopulation(),this.drawField()});i(this,"calcSpeedInputChange",()=>{const t=this.played;this.stopGame();const e=this.nodes.popupSpeedRangeNode.valueAsNumber,s=Number(this.nodes.popupSpeedRangeNode.max),o=Number(this.nodes.popupSpeedRangeNode.min),p=s-o,r=(e-o)/p,a=Number((r*9+1).toFixed(1));this.speed=a,this.nodes.popupSpeedInfoNode.textContent=String(this.speed),this.localStorageUse&&this.setLocalStorage("speed",this.speed),t===!0&&this.startGame()});i(this,"clear",()=>{this.loading,this.stopGame(),this.gameTime=0,this.gameLastTime=0,this.gameStartTime=0,this.cycles=0,this.disableInputs(),this.sendWorkerInitFields({random:!1,rows:this.rows,cols:this.cols}).then(t=>{this.drawField(),this.renderTime(),this.renderPopup(),this.enableInputs()})});i(this,"generateNewFields",()=>{this.loading,this.sendWorkerInitFields({random:!0,rows:this.rows,cols:this.cols}).then(t=>{this.cycles=0,this.drawField(),this.renderPopup()})});i(this,"resizeAndDraw",()=>{this.setCanvasSize(),this.drawField()});i(this,"setColorCell",()=>{this.colorCell=getComputedStyle(document.documentElement).getPropertyValue("--color")});i(this,"setColorCellAndDraw",()=>{this.setColorCell(),this.drawField()});i(this,"setCanvasSize",()=>{const t=this.nodes.wrapperCanvasNode.offsetWidth,e=this.nodes.wrapperCanvasNode.offsetHeight,s=this.cols/this.rows,o=Math.min(t,e*s),p=o/s;this.cellSize=o/this.cols;const n=(t-o)/2,r=(e-p)/2;this.nodes.canvasNode.width=o,this.nodes.canvasNode.height=p,this.nodes.wrapperCanvasNode.style.padding=`${r}px ${n}px`});i(this,"stepGame",()=>{if(this.loading!==!0)return this.sendWorkerUpdateField().then(t=>(this.drawField(),this.cycles=this.cycles+1,this.renderPopup(),t))});i(this,"stepAnimationRenderTime",()=>{this.renderTime()});if(p<1)throw new Error("GameOfLife: speed не может быть меньше 1");if(p>10)throw new Error("GameOfLife: speed не может быть больше 10");this.rows=e,this.cols=s,this.random=o,this.speed=p,this.localStorageUse=n,this.popupHidden=r,this.initNodes(t),this.ctx=this.nodes.canvasNode.getContext("2d"),this.localStorageUse&&this.useLocalStorage(),this.initCalcSpeed(),this.setCanvasSize(),this.setColorCell(),this.initInputNodes(),this.initPopupHidden(),this.sendWorkerInitFields({random:this.random,rows:this.rows,cols:this.cols}).then(({activeCells:a,field:d,buffer:u})=>{this.initEventListeners(),this.drawField(),this.renderPopup()})}initInputNodes(){this.nodes.popupInputRowsNode.value=String(this.rows),this.nodes.popupInputColsNode.value=String(this.cols)}initPopupHidden(){this.togglePopup(this.popupHidden)}disableInputs(){this.nodes.popupInputRowsNode.disabled=!0,this.nodes.popupInputColsNode.disabled=!0}enableInputs(){this.nodes.popupInputRowsNode.disabled=!1,this.nodes.popupInputColsNode.disabled=!1,this.focusedInput!==null&&(this.focusedInput.focus(),this.focusedInput=null)}sendWorkerInitFields({random:t,rows:e,cols:s}){return this.load(),this.disableInputs(),this.worker.postMessage({type:"initFields",payload:{random:t,rows:e,cols:s}}),new Promise((p,n)=>{this.worker.onmessage=r=>{const a=r.data;if(this.loadComplete(),this.enableInputs(),a.type==="result: initFields"){const d=a.data,{activeCells:u,field:c,buffer:h}=d;this.activeCells=u,this.field=c,this.buffer=h,p(d)}n(!1)}})}load(){this.loading=!0,this.nodes.popupLoadNode.classList.add("popup__load_active"),this.nodes.popupNode.classList.add("popup_load")}loadComplete(){this.loading=!1,this.nodes.popupLoadNode.classList.remove("popup__load_active"),this.nodes.popupNode.classList.remove("popup_load")}initEventListeners(){window.addEventListener("resize",this.resizeAndDraw),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",this.setColorCellAndDraw),this.nodes.popupPauseNode.addEventListener("click",()=>{this.played!==!1&&this.stopGame()}),this.nodes.popupPlayNode.addEventListener("click",()=>{this.played!==!0&&this.startGame()}),this.nodes.popupGenerateNode.addEventListener("click",this.generateNewFields),this.nodes.canvasNode.addEventListener("pointerdown",e=>{if(this.loading!==!0){if(e.button===2||e.button===1)return!1;this.isDragging=!0,this.isRealDragging=!1}}),this.nodes.canvasNode.addEventListener("pointermove",e=>{if(e.button===2||e.button===1)return!1;this.isDragging===!0&&this.loading===!1&&(this.isRealDragging=!0,this.generateCellByClick(e,!0))}),document.addEventListener("pointerup",e=>{if(e.button===2||e.button===1)return!1;this.isClickOnElement(e,this.nodes.popupNode)!==!0&&(this.isRealDragging===!1&&this.loading===!1&&this.generateCellByClick(e,!1),this.isDragging=!1,this.isRealDragging=!1)}),this.nodes.popupRandomCheckboxNode.addEventListener("input",()=>{this.random=!this.random,this.localStorageUse&&this.setLocalStorage("random",this.random),this.renderRandom()}),this.nodes.popupSpeedRangeNode.addEventListener("input",this.calcSpeedInputChange),this.nodes.popupClearNode.addEventListener("click",this.clear),this.nodes.popupStepNode.addEventListener("click",()=>{var e;this.disableInputs(),(e=this.stepGame())==null||e.then(s=>{this.enableInputs()})}),this.nodes.popupInputRowsNode.addEventListener("input",()=>{const e=_(this.nodes.popupInputRowsNode,0,2e3);this.localStorageUse&&this.setLocalStorage("rows",e),this.focusedInput=this.nodes.popupInputRowsNode,this.resizeFieldRows(e)}),this.nodes.popupInputColsNode.addEventListener("input",()=>{const e=_(this.nodes.popupInputColsNode,0,2e3);this.localStorageUse&&this.setLocalStorage("cols",e),this.focusedInput=this.nodes.popupInputColsNode,this.resizeFieldCols(e)}),this.nodes.popupCloseNode.addEventListener("click",()=>{this.popupHidden=!this.popupHidden,this.togglePopup(this.popupHidden)})}resizeFieldRows(t){this.loading!==!0&&this.sendWorkerResizeField(t,this.cols,this.random).then(e=>{this.setCanvasSize(),this.drawField(),this.renderTime(),this.renderPopup()})}resizeFieldCols(t){this.loading!==!0&&this.sendWorkerResizeField(this.rows,t,this.random).then(e=>{this.setCanvasSize(),this.drawField(),this.renderTime(),this.renderPopup()})}sendWorkerResizeField(t,e,s){return this.load(),this.disableInputs(),this.worker.postMessage({type:"resizeField",payload:{newRows:t,newCols:e,random:s}}),new Promise((p,n)=>{this.worker.onmessage=r=>{const a=r.data;if(this.loadComplete(),this.enableInputs(),a.type==="result: resizeField"){const d=a.data,{field:u,buffer:c,activeCells:h,rows:m,cols:f}=d;this.field=u,this.buffer=c,this.activeCells=h,this.rows=m,this.cols=f,p(d)}n(!1)}}).catch(()=>{})}isClickOnElement(t,e){let o=t.target;for(;o!=null;){if(o===e)return!0;o=o.parentElement}return!1}sendWorkerDeleteOrCreateCell(t,e){return this.load(),this.worker.postMessage({type:"deleteOrCreateCell",payload:{typeAction:t,key:e}}),new Promise((o,p)=>{this.worker.onmessage=n=>{const r=n.data;if(this.loadComplete(),r.type==="result: deleteOrCreateCell"){const a=r.data;o(a)}p(!1)}})}initCalcSpeed(){const t=Number(this.nodes.popupSpeedRangeNode.max),e=Number(this.nodes.popupSpeedRangeNode.min),s=(this.speed-1)/9,o=e+s*(t-e);this.nodes.popupSpeedRangeNode.value=String(o),this.nodes.popupSpeedInfoNode.textContent=String(this.speed)}useLocalStorage(){const t=this.getLocalStorage();t.random!==void 0&&(this.random=t.random),t.speed!==void 0&&(this.speed=t.speed),t.rows!==void 0&&(this.rows=t.rows),t.cols!==void 0&&(this.cols=t.cols),t.popupHidden!==void 0&&(this.popupHidden=t.popupHidden)}initNodes(t){t.innerHTML=`
			<div class="wrapper">
				<div class="wrapper-canvas">
					<canvas class="canvas"></canvas>
				</div>

				<div class="popup">
					<div class="popup__item popup__play">Play</div>
					<div class="popup__item popup__pause">Пауза</div>
					<div class="popup__item popup__clear">Очистить</div>
					<div class="popup__item popup__step">Шаг</div>
					<div class="popup__item popup__generate">Сгенерировать</div>
					<label class="popup__item popup__random-checkbox-item">
						<input type="checkbox" class="popup__random-checkbox">
						<span>Рандом</span>
					</label>
					<div class="popup__item">
						Время:
						<span class="popup__time">0.0</span>
					</div>
					<div class="popup__item">Поколение: <span class="popup__cycles">0</span></div>
					<div class="popup__item">Население: <span class="popup__population">0</span></div>
					<div class="popup__item">
						<span>Скорость: </span>
						<span class="popup__speed-info">1</span>
					</div>
					<div class="popup__item">
						<input class="popup__speed-range" type="range" min="0" max="100" value="50">
					</div>

					<div class="popup__item popup__item_inputs">
						<input type="number" class="popup__rows popup__inputs" placeholder="rows" min="0" max="2000">
						<input type="number" class="popup__cols popup__inputs" placeholder="cols" min="0" max="2000">
					</div>

					<div class="popup__item popup__close">Скрыть</div>

					<div class="popup__item popup__load">Загрузка</div>

				</div>

			</div>
		`;const e=this._querySelector(t,".popup"),s=this._querySelector(t,".canvas"),o=this._querySelector(t,".wrapper-canvas"),p=this._querySelector(e,".popup__play"),n=this._querySelector(e,".popup__pause"),r=this._querySelector(e,".popup__time"),a=this._querySelector(e,".popup__population"),d=this._querySelector(e,".popup__cycles"),u=this._querySelector(e,".popup__generate"),c=this._querySelector(e,".popup__random-checkbox"),h=this._querySelector(e,".popup__speed-range"),m=this._querySelector(e,".popup__speed-info"),f=this._querySelector(e,".popup__clear"),C=this._querySelector(e,".popup__step"),w=this._querySelector(e,".popup__load"),v=this._querySelector(e,".popup__rows"),S=this._querySelector(e,".popup__cols"),y=this._querySelector(e,".popup__close");this.nodes={canvasNode:s,popupNode:e,popupPlayNode:p,popupPauseNode:n,popupTimeNode:r,popupPopulationNode:a,popupCyclesNode:d,popupGenerateNode:u,wrapperCanvasNode:o,popupRandomCheckboxNode:c,popupSpeedRangeNode:h,popupSpeedInfoNode:m,popupClearNode:f,popupStepNode:C,popupLoadNode:w,popupInputRowsNode:v,popupInputColsNode:S,popupCloseNode:y}}_querySelector(t,e){const s=t.querySelector(e);if(s===null)throw new Error(`GameOfLife: элемент с классом ${e} не найден`);return s}getKey(t,e){return`${t}-${e}`}drawField(){this.load(),this.ctx.clearRect(0,0,this.nodes.canvasNode.width,this.nodes.canvasNode.height);const t=this.cellSize;this.ctx.fillStyle=this.colorCell;for(let e=0;e<this.rows;e++)for(let s=0;s<this.cols;s++){const o=this.getKey(e,s);this.field.get(o)&&this.ctx.fillRect(s*t,e*t,t,t)}this.loadComplete()}sendWorkerUpdateField(){return this.load(),this.worker.postMessage({type:"updateField",payload:{}}),new Promise((e,s)=>{this.worker.onmessage=o=>{const p=o.data;if(this.loadComplete(),p.type==="result: updateField"){const n=p.data,{activeCells:r,field:a,buffer:d}=n;this.activeCells=r,this.field=a,this.buffer=d,e(n)}s(!1)}})}renderPopup(){this.renderPopulation(),this.renderRandom(),this.nodes.popupCyclesNode.textContent=String(this.cycles),this.nodes.popupRandomCheckboxNode.checked=this.random}renderTime(){let t=Date.now()-this.gameStartTime+this.gameLastTime;this.gameStartTime===0&&(t=0),this.gameTime=t,this.nodes.popupTimeNode.textContent=(this.gameTime/1e3).toFixed(1)}renderRandom(){this.random===!0?this.nodes.popupGenerateNode.classList.add("popup__generate_active"):this.nodes.popupGenerateNode.classList.remove("popup__generate_active")}renderPopulation(){this.nodes.popupPopulationNode.textContent=String(this.activeCells)}startGame(){this.disableInputs(),this.played=!0,this.gameStartTime=Date.now(),this.animationObj=g(this.stepGame,this.interval/this.speed**1.5),this.animationTimeId=g(this.stepAnimationRenderTime)}stopGame(){this.played!==!1&&(this.played=!1,this.gameLastTime=this.gameTime,cancelAnimationFrame(this.animationObj.id),cancelAnimationFrame(this.animationTimeId.id),this.enableInputs())}getLocalStorage(){return JSON.parse(localStorage.getItem("life")||"{}")}setLocalStorage(t,e){const s=this.getLocalStorage();s[t]=e,localStorage.setItem("life",JSON.stringify(s))}}const N=document.querySelector(".injected-game-life");if(N===null)throw new Error("injectedNode не найден");new b({cellsCountX:100,cellsCountY:100,random:!1,speed:1,localStorageUse:!0,popupHidden:!1,injectedNode:N});
